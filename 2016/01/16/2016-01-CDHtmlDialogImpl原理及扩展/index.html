<html>
<head>
  <meta charset="utf-8">
  
  <title>基于CDHtmlDialogImpl的hybird app原理及扩展 | 技术人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="CDHtmlDialog简介在MFC中，有这样一个类库：CDHtmlDialog，它可以在win32窗口中嵌入浏览器控件，使用起来挺方便，但是在WTL中，却不带这个类库。所幸的是，有一个开源项目提供了WTL版的CDHtmlDialog类，http://code.google.com/p/htmlui主要功能是放在HtmlDialogImpl.h中实现的
CDHtmlDialog简单使用HtmlDi">
<meta property="og:type" content="article">
<meta property="og:title" content="基于CDHtmlDialogImpl的hybird app原理及扩展">
<meta property="og:url" content="http://blog.uxfork.cn/2016/01/16/2016-01-CDHtmlDialogImpl原理及扩展/index.html">
<meta property="og:site_name" content="技术人生">
<meta property="og:description" content="CDHtmlDialog简介在MFC中，有这样一个类库：CDHtmlDialog，它可以在win32窗口中嵌入浏览器控件，使用起来挺方便，但是在WTL中，却不带这个类库。所幸的是，有一个开源项目提供了WTL版的CDHtmlDialog类，http://code.google.com/p/htmlui主要功能是放在HtmlDialogImpl.h中实现的
CDHtmlDialog简单使用HtmlDi">
<meta property="og:image" content="http://blog.uxfork.cn/images/rc_fmt.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/hybird-win32.png">
<meta property="og:updated_time" content="2016-01-16T11:22:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于CDHtmlDialogImpl的hybird app原理及扩展">
<meta name="twitter:description" content="CDHtmlDialog简介在MFC中，有这样一个类库：CDHtmlDialog，它可以在win32窗口中嵌入浏览器控件，使用起来挺方便，但是在WTL中，却不带这个类库。所幸的是，有一个开源项目提供了WTL版的CDHtmlDialog类，http://code.google.com/p/htmlui主要功能是放在HtmlDialogImpl.h中实现的
CDHtmlDialog简单使用HtmlDi">
  
    <link rel="alternative" href="/atom.xml" title="技术人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/zhihu.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/zhihu.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">uxfork</a></h1>
		</hgroup>

		
		<p class="header-subtitle">记录点点滴滴</p>
		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">true</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">uxfork</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/zhihu.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">uxfork</h1>
			</hgroup>
			
			<p class="header-subtitle">记录点点滴滴</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2016-01-CDHtmlDialogImpl原理及扩展" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/16/2016-01-CDHtmlDialogImpl原理及扩展/" class="article-date">
  	<time datetime="2016-01-16T11:22:23.000Z" itemprop="datePublished">2016-01-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      基于CDHtmlDialogImpl的hybird app原理及扩展
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hybird/">hybird</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows/">windows</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CDHtmlDialog_u7B80_u4ECB"><a href="#CDHtmlDialog_u7B80_u4ECB" class="headerlink" title="CDHtmlDialog简介"></a>CDHtmlDialog简介</h1><p>在MFC中，有这样一个类库：CDHtmlDialog，它可以在win32窗口中嵌入浏览器控件，使用起来挺方便，但是在WTL中，却不带这个类库。<br>所幸的是，有一个开源项目提供了WTL版的CDHtmlDialog类，<a href="http://code.google.com/p/htmlui" target="_blank" rel="external">http://code.google.com/p/htmlui</a><br>主要功能是放在<strong>HtmlDialogImpl.h</strong>中实现的</p>
<h1 id="CDHtmlDialog_u7B80_u5355_u4F7F_u7528"><a href="#CDHtmlDialog_u7B80_u5355_u4F7F_u7528" class="headerlink" title="CDHtmlDialog简单使用"></a>CDHtmlDialog简单使用</h1><p>HtmlDialogImpl.h文件提供了两个模板类： <strong>CDHtmlDialogImpl</strong> 和 <strong>CMultiPageDHtmlDialogImpl</strong><br>基本使用：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   继承CDHtmlDialogImpl类</span><br><span class="line">   <span class="keyword">class</span> CMainDlg : <span class="keyword">public</span> CDHtmlDialogImpl&lt;CMainDlg&gt; &#123;...&#125;</span><br><span class="line">   </span><br><span class="line">   初始化，使用</span><br><span class="line">   CMainDlg dlg;</span><br><span class="line">   dlg.m_strCurrentUrl = _T(<span class="string">"www.microsoft.com"</span>); </span><br><span class="line">   dlg.Create(<span class="literal">NULL</span>); 或者调用 dlg.DoModal(<span class="literal">NULL</span>);</span><br><span class="line">或者在OnInitDialog函数中，调用Navigate访问资源，例如</span><br><span class="line">WCHAR wszRes[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">GetModuleFileName(<span class="literal">NULL</span>, wszRes, MAX_PATH);</span><br><span class="line">PathRemoveFileSpec(wszRes);</span><br><span class="line">wcsncat_s(wszRes, MAX_PATH, <span class="string">L"\\skin.dll"</span>, _TRUNCATE);</span><br><span class="line">CString url;</span><br><span class="line">url.Format(<span class="string">L"res://%s/htm/main.html"</span>, wszRes);</span><br><span class="line"></span><br><span class="line">Navigate(url, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<p>重写全局文档相关的DWebBrowser2Events事件处理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> CMainDlg : <span class="keyword">public</span> CDHtmlDialogImpl&lt;CMainDlg&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnBeforeNavigate</span><span class="params">(LPDISPATCH pDisp, LPCTSTR szUrl)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnNavigateComplete</span><span class="params">(LPDISPATCH pDisp, LPCTSTR szUrl)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnDocumentComplete</span><span class="params">(LPDISPATCH pDisp, LPCTSTR szUrl)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加IHTMLDocument2Events网页元素事件处理函数<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> CMainDlg : <span class="keyword">public</span> CDHtmlDialogImpl&lt;CMainDlg&gt;</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	BEGIN_DHTML_EVENT_MAP(CMainDlg)</span><br><span class="line">		DHTML_EVENT_ONCLICK(_T(<span class="string">"elementid1"</span>), OnClick)</span><br><span class="line">		DHTML_EVENT_ONMOUSEMOVE(_T(<span class="string">"elementid2"</span>), OnMouseMove)</span><br><span class="line">	END_DHTML_EVENT_MAP()</span><br><span class="line">	<span class="function">HRESULT <span class="title">OnClick</span><span class="params">(IHTMLElement *pElement)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">		<span class="keyword">return</span> S_OK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">HRESULT <span class="title">OnMouseMove</span><span class="params">(IHTMLElement *pElement)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">		<span class="keyword">return</span> S_OK;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>直接添加IHTMLElement事件处理函数</strong>(前面的DHTML_EVENT_ONCLICK、DHTML_EVENT_ONMOUSEMOVE事件其实就是DHTML_EVENT宏的进一步封装)<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> CMainDlg : <span class="keyword">public</span> CDHtmlDialogImpl&lt;CMainDlg&gt;</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	BEGIN_DHTML_EVENT_MAP(CMainDlg)</span><br><span class="line">		DHTML_EVENT_ELEMENT(DISPID_HTMLELEMENTEVENTS_ONMOUSEOVER, _T(<span class="string">"elementid"</span>), OnMouseOver)</span><br><span class="line">		DHTML_EVENT_CLASS(DISPID_HTMLELEMENTEVENTS_ONMOUSEOVER, _T(<span class="string">"classname"</span>), OnMouseOver)</span><br><span class="line">		DHTML_EVENT_TAG(DISPID_HTMLELEMENTEVENTS_ONMOUSEOVER, _T(<span class="string">"tagname"</span>), OnMouseOver)</span><br><span class="line">	END_DHTML_EVENT_MAP()</span><br><span class="line">	<span class="function">HRESULT <span class="title">OnMouseOver</span><span class="params">(IHTMLElement *pElement)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">		<span class="keyword">return</span> S_OK;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>我们看一下这几个宏</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据元素name绑定事件</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> DHTML_EVENT(dispid, elemName, memberFxn)\</span><br><span class="line">&#123; DHTMLEVENTMAPENTRY_NAME, dispid, elemName, (DHEVTFUNCCONTROL) (DHEVTFUNC) &amp;theClass::memberFxn &#125;,\</span><br><span class="line"><span class="comment">//根据元素class name绑定事件</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> DHTML_EVENT_CLASS(dispid, elemName, memberFxn)\</span><br><span class="line">&#123; DHTMLEVENTMAPENTRY_CLASS, dispid, elemName, (DHEVTFUNCCONTROL) (DHEVTFUNC) &amp;theClass::memberFxn &#125;,\</span><br><span class="line"><span class="comment">//根据tag name绑定事件</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> DHTML_EVENT_TAG(dispid, elemName, memberFxn)\</span><br><span class="line">&#123; DHTMLEVENTMAPENTRY_TAG, dispid, elemName, (DHEVTFUNCCONTROL) (DHEVTFUNC) &amp;theClass::memberFxn &#125;,\</span><br><span class="line"><span class="comment">///根据element绑定事件</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> DHTML_EVENT_ELEMENT(dispid, elemName, memberFxn)\</span><br><span class="line">&#123; DHTMLEVENTMAPENTRY_ELEMENT, dispid, elemName, (DHEVTFUNCCONTROL) (DHEVTFUNC) &amp;theClass::memberFxn &#125;,\</span><br><span class="line">根据activex控件绑定事件</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> DHTML_EVENT_AXCONTROL(dispid, controlName, memberFxn)\</span><br><span class="line">&#123; DHTMLEVENTMAPENTRY_CONTROL, dispid, controlName, (DHEVTFUNCCONTROL) (static_cast&lt;void (__stdcall theClass::*)()&gt;(&amp;theClass::memberFxn)) &#125;,\</span><br><span class="line"></span></span><br><span class="line">```	</span><br><span class="line">**绑定activex控件的事件回调**</span><br><span class="line">```C++</span><br><span class="line"><span class="keyword">class</span> CMainDlg : <span class="keyword">public</span> CDHtmlDialogImpl&lt;CMainDlg&gt;</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	BEGIN_DHTML_EVENT_MAP(CMainDlg)</span><br><span class="line">		DHTML_EVENT_AXCONTROL(controlMethodDISPID, _T(<span class="string">"objectid"</span>), OnControlMethod)</span><br><span class="line">	END_DHTML_EVENT_MAP()</span><br><span class="line">	<span class="function">HRESULT <span class="title">OnControlMethod</span><span class="params">(IHTMLElement *pElement)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">		<span class="keyword">return</span> S_OK;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>绑定external调用的dispatch回调    </strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> CMainDlg : <span class="keyword">public</span> CDHtmlDialogImpl&lt;CMainDlg&gt;</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	BEGIN_EXTERNAL_METHOD_MAP(CMainDlg)</span><br><span class="line">		EXTERNAL_METHOD(_T(<span class="string">"about"</span>), OnAbout)  <span class="comment">// script calls "window.external.about(123, "abc");"</span></span><br><span class="line">	END_EXTERNAL_METHOD_MAP()</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnAbout</span><span class="params">(VARIANT* para1, VARIANT* para2, VARIANT* para3)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line">```	</span><br><span class="line">**多页面对话框**</span><br><span class="line">```C++</span><br><span class="line"><span class="keyword">class</span> CMainDlg : <span class="keyword">public</span> CMultiPageDHtmlDialogImpl&lt;CMainDlg&gt;</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	BEGIN_URL_ENTRIES_MAP(CMainDlg)</span><br><span class="line">		BEGIN_DHTML_URL_EVENT_MAP(<span class="number">1</span>)	<span class="comment">/// map in page1.htm</span></span><br><span class="line">			DHTML_EVENT_ONCLICK(_T(<span class="string">"elementid"</span>), OnClick)</span><br><span class="line">			DHTML_EVENT_AXCONTROL(controlMethodDISPID, _T(<span class="string">"objectid"</span>), OnControlMethod)</span><br><span class="line">		END_DHTML_URL_EVENT_MAP()</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">		BEGIN_DHTML_URL_EVENT_MAP(<span class="number">2</span>)	<span class="comment">/// map in page2.htm</span></span><br><span class="line">			DHTML_EVENT_ELEMENT(DISPID_HTMLELEMENTEVENTS_ONMOUSEOVER, _T(<span class="string">"elementid"</span>), OnMouseOver)</span><br><span class="line">		END_DHTML_URL_EVENT_MAP()</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">		BEGIN_URL_ENTRIES()</span><br><span class="line">			URL_EVENT_ENTRY(_T(<span class="string">"page1.htm"</span>), <span class="number">1</span>)</span><br><span class="line">			URL_EVENT_ENTRY(_T(<span class="string">"page2.htm"</span>), <span class="number">2</span>)</span><br><span class="line">		END_URL_ENTRIES()</span><br><span class="line">	END_URL_ENTRIES_MAP()</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">	<span class="function">HRESULT <span class="title">OnMouseOver</span><span class="params">(IHTMLElement *pElement)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// your code is here.</span></span><br><span class="line">		<span class="keyword">return</span> S_OK;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>html网页中控制窗口展示</strong><br>在body元素中，可以定义dlg_autosize= true，表示host窗口，可调整大小，否则dlg_width和dlg_height元素有效，规定窗口大小<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body dlg_autosize=<span class="string">"false"</span> dlg_width=<span class="string">"600"</span> dlg_height=<span class="string">"300"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>内置了几个external函数</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> DHtmlExternalMethodMapEntry _dhtmlExtMethodEntries[] = &#123; \</span><br><span class="line">&#123; _T(<span class="string">"resizeWindow"</span>), (EXTFUNCCONTROL)(EXTFUNC) &amp;theClass::OnResizeWindow &#125;,\</span><br><span class="line">&#123; _T(<span class="string">"centerWindow"</span>), (EXTFUNCCONTROL)(EXTFUNC) &amp;theClass::OnCenterWindow &#125;,\</span><br><span class="line">&#123; _T(<span class="string">"showTitleBar"</span>), (EXTFUNCCONTROL)(EXTFUNC) &amp;theClass::OnShowTitleBar &#125;,</span><br></pre></td></tr></table></figure>
<p>在js中调用这些函数用来动态调整窗口大小、窗口居中，隐藏显示系统标题栏<br>window.external.showTitleBar(1);</p>
<h1 id="CDHtmlDialog_u7684_u5B9E_u73B0"><a href="#CDHtmlDialog_u7684_u5B9E_u73B0" class="headerlink" title="CDHtmlDialog的实现"></a>CDHtmlDialog的实现</h1><p>CDHtmlDialog类继承了这几个基类：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> T, <span class="keyword">class</span> TBase = ATL::CWindow&gt;</span><br><span class="line"><span class="keyword">class</span> ATL_NO_VTABLE CDHtmlDialogImpl :</span><br><span class="line">	<span class="keyword">public</span> ATL::CDialogImplBaseT&lt; TBase &gt;,</span><br><span class="line">	<span class="keyword">public</span> CDHtmlEventSink,</span><br><span class="line">	<span class="keyword">public</span> CExternalDispatchImpl&lt;CDHtmlDialogImpl&lt;T,TBase&gt; &gt;,</span><br><span class="line">	<span class="keyword">public</span> IDocHostUIHandlerDispatchImpl&lt;CDHtmlDialogImpl&lt;T,TBase&gt; &gt;,</span><br><span class="line">	<span class="keyword">public</span> DWebBrowserEvent2Impl&lt;CDHtmlDialogImpl&lt;T,TBase&gt; &gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">typedef</span> CDHtmlDialogImpl&lt;T,TBase&gt; thisClass;</span><br><span class="line">	<span class="keyword">typedef</span> ATL::CDialogImplBaseT&lt; TBase &gt; baseDialog;</span><br><span class="line">	<span class="keyword">typedef</span> IDocHostUIHandlerDispatchImpl&lt;CDHtmlDialogImpl&lt;T,TBase&gt; &gt; DocHostUIHandlerDispatch;</span><br><span class="line">	<span class="keyword">typedef</span> DWebBrowserEvent2Impl&lt;CDHtmlDialogImpl&lt;T,TBase&gt; &gt; WebBrowserEvent2;</span><br></pre></td></tr></table></figure></p>
<p>CDHtmlDialog::Create函数和CDHtmlDialog::DoModal函数是整个模板类的初始化函数，函数中调用如下代码，创建dialog窗口<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HWND hWnd = ::CreateDialogParam(</span><br><span class="line">    _AtlBaseModule.GetResourceInstance(), </span><br><span class="line">    MAKEINTRESOURCE(<span class="keyword">static_cast</span>&lt;T*&gt;(<span class="keyword">this</span>)-&gt;IDD),</span><br><span class="line">    hWndParent, </span><br><span class="line">    T::StartDialogProc, </span><br><span class="line">    dwInitParam);</span><br></pre></td></tr></table></figure></p>
<p>实际的窗口类为<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	thisClass* pThis = (thisClass*)hWnd;</span><br><span class="line">	<span class="keyword">if</span> (uMsg == WM_INITDIALOG)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//创建ActiveX控件</span></span><br><span class="line">		pThis-&gt;m_wndBrowser.Create(pThis-&gt;m_hWnd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, WS_CHILD|WS_VISIBLE);</span><br><span class="line">		<span class="keyword">if</span> (pThis-&gt;m_wndBrowser.IsWindow())</span><br><span class="line">		&#123;</span><br><span class="line">			LPOLESTR szClsid = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="keyword">if</span> (S_OK == StringFromCLSID(CLSID_WebBrowser, &amp;szClsid))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//ActiveX控件上创建WebBrowser控件</span></span><br><span class="line">				<span class="keyword">if</span> (SUCCEEDED(pThis-&gt;m_wndBrowser.CreateControl(szClsid)))</span><br><span class="line">				&#123;</span><br><span class="line">					pThis-&gt;m_wndBrowser.SetExternalUIHandler((DocHostUIHandlerDispatch*)pThis);</span><br><span class="line">					pThis-&gt;m_wndBrowser.QueryControl(IID_IWebBrowser2, (<span class="keyword">void</span>**)&amp;pThis-&gt;m_pBrowserApp);</span><br><span class="line">					pThis-&gt;ConnectToWebBrowser(pThis-&gt;m_pBrowserApp);</span><br><span class="line">				&#125;</span><br><span class="line">				CoTaskMemFree(szClsid);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//pThis-&gt;m_wndBrowser.ShowWindow(SW_SHOW);</span></span><br><span class="line">			pThis-&gt;SendMessage(WM_SIZE);</span><br><span class="line">		&#125;</span><br><span class="line">		USES_CONVERSION;</span><br><span class="line">		<span class="keyword">if</span> (pThis-&gt;m_strDlgCaption.Length()&gt;<span class="number">0</span>)</span><br><span class="line">			pThis-&gt;SetWindowText(W2CT(pThis-&gt;m_strDlgCaption));</span><br><span class="line">		<span class="keyword">if</span> (pThis-&gt;m_nHtmlResID)</span><br><span class="line">   			pThis-&gt;LoadFromResource(pThis-&gt;m_nHtmlResID);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (pThis-&gt;m_szHtmlResID)</span><br><span class="line">			pThis-&gt;LoadFromResource(pThis-&gt;m_szHtmlResID);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (pThis-&gt;m_strCurrentUrl)</span><br><span class="line">			pThis-&gt;Navigate(OLE2CT(pThis-&gt;m_strCurrentUrl));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (uMsg == WM_DESTROY)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//销毁窗口</span></span><br><span class="line">		pThis-&gt;DisconnectDHtmlEvents();</span><br><span class="line">		pThis-&gt;m_spHtmlDoc = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="comment">// now tell the browser control we're shutting down</span></span><br><span class="line">		<span class="keyword">if</span> (pThis-&gt;m_pBrowserApp)</span><br><span class="line">		&#123;</span><br><span class="line">			pThis-&gt;DisconnectToWebBrowser(pThis-&gt;m_pBrowserApp);</span><br><span class="line">			CComPtr&lt;IOleObject&gt; spObject;</span><br><span class="line">			pThis-&gt;m_pBrowserApp-&gt;QueryInterface(IID_IOleObject, (<span class="keyword">void</span> **) &amp;spObject);</span><br><span class="line">			<span class="keyword">if</span> (spObject != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				spObject-&gt;Close(OLECLOSE_NOSAVE);</span><br><span class="line">				spObject.Release();</span><br><span class="line">			&#125;</span><br><span class="line">			pThis-&gt;m_pBrowserApp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (pThis-&gt;m_wndBrowser.IsWindow())</span><br><span class="line">			pThis-&gt;m_wndBrowser.DestroyWindow();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (uMsg == WM_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//修改窗口大小</span></span><br><span class="line">		<span class="keyword">if</span> (!pThis-&gt;m_bAttachedControl &amp;&amp; pThis-&gt;m_wndBrowser.m_hWnd)</span><br><span class="line">		&#123;</span><br><span class="line">			RECT rc;</span><br><span class="line">			pThis-&gt;GetClientRect(&amp;rc);</span><br><span class="line">			pThis-&gt;m_wndBrowser.MoveWindow(<span class="number">0</span>, <span class="number">0</span>, (<span class="keyword">int</span>)(rc.right-rc.left), (<span class="keyword">int</span>)(rc.bottom-rc.top));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (uMsg == WM_GETMINMAXINFO)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//如果设置固定大小,这里就是控制固定大小空间</span></span><br><span class="line">		<span class="keyword">if</span> (!pThis-&gt;m_AutoSize)</span><br><span class="line">		&#123;</span><br><span class="line">			MINMAXINFO* lpMMI = (MINMAXINFO*)lParam;</span><br><span class="line">			lpMMI-&gt;ptMinTrackSize.x = pThis-&gt;m_Width;</span><br><span class="line">			lpMMI-&gt;ptMinTrackSize.y = pThis-&gt;m_Height;</span><br><span class="line">			lpMMI-&gt;ptMaxTrackSize.x = pThis-&gt;m_Width;</span><br><span class="line">			lpMMI-&gt;ptMaxTrackSize.y = pThis-&gt;m_Height;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> baseDialog::DialogProc(hWnd, uMsg, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>控制host窗口大小<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _OnDocumentComplete(LPDISPATCH pDisp, VARIANT* URL)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (pDisp != m_pBrowserApp)</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		ConnectDHtmlElementEvents((((DWORD_PTR)<span class="keyword">static_cast</span>&lt; CDHtmlSinkHandler* &gt;(<span class="keyword">this</span>)) - (DWORD_PTR)<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">		CComBSTR title;</span><br><span class="line">		GetDocTitle(title);</span><br><span class="line">		::SetWindowTextW(m_hWnd, title);</span><br><span class="line"></span><br><span class="line">		m_AutoSize = TRUE;</span><br><span class="line">		<span class="keyword">if</span> (!GetDocAttribute(_T(<span class="string">"dlg_autosize"</span>), m_AutoSize) || !m_AutoSize)</span><br><span class="line">		&#123;</span><br><span class="line">			m_Height = <span class="number">0</span>;</span><br><span class="line">			m_Width = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (GetDocAttribute(_T(<span class="string">"dlg_width"</span>), m_Width) &amp;&amp;</span><br><span class="line">				GetDocAttribute(_T(<span class="string">"dlg_height"</span>), m_Height) &amp;&amp;</span><br><span class="line">				m_Width &amp;&amp;</span><br><span class="line">				m_Height)</span><br><span class="line">			&#123;</span><br><span class="line">				ResizeHostWindow(m_Width, m_Height);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		(<span class="keyword">static_cast</span>&lt;T*&gt;(<span class="keyword">this</span>))-&gt;OnDocumentComplete(pDisp, W2CT(V_BSTR(URL)));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="u7F51_u9875_u76AE_u80A4_u8D44_u6E90_u5305"><a href="#u7F51_u9875_u76AE_u80A4_u8D44_u6E90_u5305" class="headerlink" title="网页皮肤资源包"></a>网页皮肤资源包</h1><p>一般情况下，都是打开一个http网页地址，但如果断开网络时，我们的页面就不展示。有时候需要打开本地的资源文件。这里，我对本地资源包做了一些抽象，最终效果是将资源文件打包为一个DLL<br>在一个<strong>纯资源DLL工程</strong>中：<br>假设我们需要包含这几个资源：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">css\bootstrap.min.css</span><br><span class="line">htm\main.html</span><br><span class="line">js\bootstrap.min.js</span><br><span class="line">js\jquery.min.js</span><br></pre></td></tr></table></figure></p>
<p>可以在DLL工程的rc文件中，添加如下内容：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MAIN.HTML               HTM                     <span class="string">"htm\main.html"</span></span><br><span class="line">BOOTSTRAP.MIN.CSS       CSS                     <span class="string">"css\bootstrap.min.css"</span></span><br><span class="line">BOOTSTRAP.MIN.JS        JS                      <span class="string">"js\bootstrap.min.js"</span></span><br><span class="line">JQUERY.MIN.JS           JS                      <span class="string">"js\jquery.min.js"</span></span><br></pre></td></tr></table></figure></p>
<p>正常情况下，rc文件一个自定义资源的格式如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUSTOM_ID				TYPE			<span class="string">"rsrc\xxx.dat"</span></span><br></pre></td></tr></table></figure></p>
<p>这里CUSTOM_ID是一个数字，其实，CUSTOM_ID域也可以是字符串,TYPE域也是字符串，PE的资源结构本身就是一个目录结构<br>生成后的DLL的资源格式如下：<br><img src="/images/rc_fmt.png" alt=""><br>在main.html网页中引用其他几个css时，只需在相对路径前加上res:/即可<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href="res:/css/bootstrap.min.css" rel="stylesheet" /&gt;</span><br><span class="line">&lt;script src="res:/js/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src="res:/js/bootstrap.min.js"&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里之所以能够省略DLL路径，是因为htm页面本身就在DLL中，webbrowser控件可以自动加上DLL路径，这样为我们制作html资源包提供了很大的方便</p>
<h1 id="u793A_u4F8B_u4EE3_u7801"><a href="#u793A_u4F8B_u4EE3_u7801" class="headerlink" title="示例代码"></a>示例代码</h1><p><a href="https://github.com/zhaozhongshu/hybird-win32" target="_blank" rel="external">hybird-win32</a></p>
<p>运行效果<br><img src="/images/hybird-win32.png" alt=""></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/01/16/2016-01-jxcore文档翻译/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">jxcore文档翻译</div>
      <strong class="article-nav-caption"></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 uxfork
    	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script type="text/javascript">
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	};
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"-->


  </div>
</body>
</html>