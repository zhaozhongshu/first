<html>
<head>
  <meta charset="utf-8">
  
  <title>ragel state compiler | 苍山溪水</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="简介
url解析
atoi案例分析
awk案例分析
C文法案例分析
多状态机实例
gotocallret使用

简介ragel类似flex词法分析器，它可以在正则表达式状态机发生转移时，嵌入解析动作，可以生成C/C++/objc等语言。
ragel是一个定义状态机的语言，它将状态机定义文件会变成C/C++代码。任何编程语言都可以转义成一个确定性有限状态机，因此任意语言都可以用一个状态机替换。rag">
<meta property="og:type" content="article">
<meta property="og:title" content="ragel state compiler">
<meta property="og:url" content="http://blog.uxfork.cn/2015/08/19/2015-08-ragel-state-compiler文档/index.html">
<meta property="og:site_name" content="苍山溪水">
<meta property="og:description" content="简介
url解析
atoi案例分析
awk案例分析
C文法案例分析
多状态机实例
gotocallret使用

简介ragel类似flex词法分析器，它可以在正则表达式状态机发生转移时，嵌入解析动作，可以生成C/C++/objc等语言。
ragel是一个定义状态机的语言，它将状态机定义文件会变成C/C++代码。任何编程语言都可以转义成一个确定性有限状态机，因此任意语言都可以用一个状态机替换。rag">
<meta property="og:image" content="http://blog.uxfork.cn/images/state_hello.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state_union1.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state1.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state2.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state3.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state4.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state5.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state6.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state7.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state8.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state9.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state10.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state11.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state12.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state13.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state14.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state15.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state16.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state17.png">
<meta property="og:image" content="http://blog.uxfork.cn/images/state18.png">
<meta property="og:updated_time" content="2015-08-19T02:06:53.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ragel state compiler">
<meta name="twitter:description" content="简介
url解析
atoi案例分析
awk案例分析
C文法案例分析
多状态机实例
gotocallret使用

简介ragel类似flex词法分析器，它可以在正则表达式状态机发生转移时，嵌入解析动作，可以生成C/C++/objc等语言。
ragel是一个定义状态机的语言，它将状态机定义文件会变成C/C++代码。任何编程语言都可以转义成一个确定性有限状态机，因此任意语言都可以用一个状态机替换。rag">
  
    <link rel="alternative" href="/atom.xml" title="苍山溪水" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/zhihu.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/zhihu.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">uxfork</a></h1>
		</hgroup>

		
		<p class="header-subtitle">记录点滴---滴水石穿</p>
		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">true</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">uxfork</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/zhihu.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">uxfork</h1>
			</hgroup>
			
			<p class="header-subtitle">记录点滴---滴水石穿</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-08-ragel-state-compiler文档" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/19/2015-08-ragel-state-compiler文档/" class="article-date">
  	<time datetime="2015-08-19T02:06:49.000Z" itemprop="datePublished">2015-08-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ragel state compiler
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/确定自动机/">确定自动机</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/算法/">算法</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><strong><a href="/#简介">简介</a></strong></li>
<li><strong><a href="/#url解析">url解析</a></strong></li>
<li><strong><a href="/#atoi案例分析">atoi案例分析</a></strong></li>
<li><strong><a href="/#awk案例分析">awk案例分析</a></strong></li>
<li><strong><a href="/#C文法案例分析">C文法案例分析</a></strong></li>
<li><strong><a href="/#多状态机实例">多状态机实例</a></strong></li>
<li><strong><a href="/#gotocallret使用">gotocallret使用</a></strong></li>
</ul>
<h1 id="u7B80_u4ECB"><a href="#u7B80_u4ECB" class="headerlink" title="简介"></a>简介</h1><pre><code>ragel类似flex词法分析器，它可以在正则表达式状态机发生转移时，嵌入解析动作，可以生成C/C++/objc等语言。
</code></pre><p>ragel是一个定义状态机的语言，它将状态机定义文件会变成C/C++代码。任何编程语言都可以转义成一个<strong>确定性有限状态机</strong>，因此任意语言都可以用一个状态机替换。<br>ragel以C, C++, Objective-C, D, Go, Java or Ruby代码的形式输出确定性有限状态机，生成的代码是非常通用的。<br>ragel状态机代码处理输入数据，当输入数据处理完，ragel状态机有“accepted”、“not accepted”两个结果。<br><strong>ragel状态机可以像正则表达式一样使用</strong>（非常好的地方时，没有正则表达式，只有C++状态机代码,效率非常高，省掉解析正则表达式）。<br><strong>ragel状态机可以用于解析输入数据</strong>（例如：http协议解析等）<br>ragel语言中定义了很多操作符，用于构造ragel状态机。一个状态机可以由需要小的状态机构造，最终<strong>一个ragel状态机代表一种语言</strong>（协议），它可以识别、解析这种语言下所有的语句（符合协议的数据）</p>
<p><strong>一个语言(状态机)</strong>, 就是一个数据串集合，多个语言(状态机)可以做union、intersection、diference、contact、kleen star操作。</p>
<h1 id="u6784_u9020_u72B6_u6001_u673A"><a href="#u6784_u9020_u72B6_u6001_u673A" class="headerlink" title="构造状态机"></a>构造状态机</h1><p>   使用ragel语法规则编写ragel状态机，然后用ragel.exe翻译生成C++代码。<br>ragel将rl文件中 %%{和}%%之间或者%%开头的单行内容当作ragel语句解析处理，其余部分不处理，直接输出。<br>一个例子：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span>  <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span>  <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">%%&#123;</span><br><span class="line">machine  foo;</span><br><span class="line">main  :=</span><br><span class="line">(  ’foo’  |  ’bar’  )</span><br><span class="line"><span class="number">0</span>  @&#123;  res  =  <span class="number">1</span>;  &#125;;</span><br><span class="line">&#125;%%</span><br><span class="line">%%  write  data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">main</span><span class="params">(  <span class="keyword">int</span>  argc,  <span class="keyword">char</span>  **argv  )</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="keyword">int</span>  cs,  res  =  <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>  (  argc  &gt;  <span class="number">1</span>  )  &#123;</span><br><span class="line"><span class="keyword">char</span>  *p  =  argv[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">char</span>  *pe  =  p  +  <span class="built_in">strlen</span>(p)  +  <span class="number">1</span>;</span><br><span class="line">%%  write  init;</span><br><span class="line">%%  write  exec;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"result  =  %i\n"</span>,  res  );</span><br><span class="line"><span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">扫描命令行输入，检查是否有foo、bar字符串</span><br></pre></td></tr></table></figure></p>
<h2 id="fsm_u547D_u540D_u8BED_u53E5"><a href="#fsm_u547D_u540D_u8BED_u53E5" class="headerlink" title="fsm命名语句"></a>fsm命名语句</h2><p>   machine  fsm_name;<br>fsm为最终状态机，这个语句给最终状态机命名，一般出现在ragel代码第一行，如果没有指定名称，则使用前一个代码块的名称，若前一个代码块没名称，则提示错误，当包含多个rl文件时，用fsmname来聚合不同文件中的状态机语句</p>
<h2 id="u72B6_u6001_u673A_u5B9A_u4E49_u8BED_u53E5"><a href="#u72B6_u6001_u673A_u5B9A_u4E49_u8BED_u53E5" class="headerlink" title="状态机定义语句"></a>状态机定义语句</h2><pre><code>&lt;name&gt;  =  &lt;expression&gt;;
</code></pre><p>状态机定义语句为FSM表达式指定一个name，在其他表达式中可以通过name引用这个表达式，状态机定义表达式不会生成任何状态，它只定义一个子状态机，以后其他地方可以使用。只有实例化之后，才会生成状态。</p>
<h2 id="u72B6_u6001_u673A_u5B9E_u4F8B_u5316_u8BED_u53E5"><a href="#u72B6_u6001_u673A_u5B9E_u4F8B_u5316_u8BED_u53E5" class="headerlink" title="状态机实例化语句"></a>状态机实例化语句</h2><pre><code>&lt;name&gt;  :=  &lt;expression&gt;;
</code></pre><p>实例化语句会生成一组状态，用来代表这个表达式。每条实例化语句都会生成一组确定的状态。每个实例化语句有一个<strong>开始状态</strong>, 在使用这条实例化语句时产生代码的data section中。<br>如果是main实例化语句，它的开始状态就是整个FSM状态机的开始状态，在<strong>write  init</strong>时，将main实例化语句的开始状态写入cs变量。<br>如果没有main实例化语句，则把最后一条实例化语句的开始状态当作整个FSM状态机的开始状态，在execution loop以外，可以通过修改cs变量，调用任何一个实例化状态。在execution loop内，只能通过fcall、fgoto、fnext语句调用任意一个实例化状态机</p>
<h2 id="include_u8BED_u53E5"><a href="#include_u8BED_u53E5" class="headerlink" title="include语句"></a>include语句</h2><pre><code>include  FsmName  &quot;inputfile.rl&quot;;
</code></pre><p>FsmName和输入文件名都可以省略，但至少有一个存在，如果没有fsmname，会从输入文件中搜索所有fsmname与当前fsmname相同的语句</p>
<h2 id="import_u8BED_u53E5"><a href="#import_u8BED_u53E5" class="headerlink" title="import语句"></a>import语句</h2><pre><code>import  &quot;inputfile.h&quot;;
</code></pre><p>该语句去掉输入文件中的如下这些关键字：<br>• name  ’=’  number<br>• name  ’=’  lit_string<br>• ’define’  name  number<br>• ’define’  name  lit_string</p>
<h2 id="ragel_u4EE3_u7801_u7684_u6B64_u6CD5_u5206_u6790"><a href="#ragel_u4EE3_u7801_u7684_u6B64_u6CD5_u5206_u6790" class="headerlink" title="ragel代码的此法分析"></a>ragel代码的此法分析</h2><p>在ragel语句中，这些此法规则会生效：<br>• #注释一行代码<br>• “”, ’’, //, [] 定义字符串，它里面的这些符号被转义：\0  \a  \b  \t  \n  \v  \f  \r，一个字符串有多行时，每行以\结尾<br>• {}用于插入host动作代码(C/C++代码)<br>• [+-]?[0-9]+ 识别数字正则<br>• 0x[0-9A-Fa-f]+ 识别16进制正则<br>• access, action, alphtype, getkey, write, machine and include关键字<br>• [a-zA-Z_][a-zA-Z_0-9]* 识别标识符正则<br>• 空白字符</p>
<h2 id="u57FA_u672C_u72B6_u6001_u673A"><a href="#u57FA_u672C_u72B6_u6001_u673A" class="headerlink" title="基本状态机"></a>基本状态机</h2><pre><code>基本的正则表达式语句。
</code></pre><p>它们是构造状态机的基本单元<br>• ‘hello’<br>生成匹配hello字符序列的状态机，开始状态+字符串长度，共6个状态，’hello’i表示忽略大小写<br><img src="/images/state_hello.png" alt=""><br>• “hello” – 同上<br>• [hello] – 一组字符，有两个状态，例如[  \t]表示空格或tab，[^…]表示不在字符列表中<br><img src="/images/state_union1.png" alt=""><br>• ‘’, “”, [] – 0长度状态机.  只有一个状态<br><img src="/images/state1.png" alt=""><br>• 42 – 数字，生成两个状态，数字42作为转移条件，数字可以是10、16进制，最大最小值由host语言决定，例如i386上short范围-32768 to 32767<br><img src="/images/state2.png" alt=""><br>• /simple_regex/ – 正则表达式，由一组表达式串联起来，每个表达式可以是：字符串、any（表示任意字符）、[]。如果忽略大小写，后面加i，例如/GET/i<br>ragel不支持非常复杂的表达式，/ab<em>[c-z].</em>[123]/. DEF表达式生成的状态图如下：<br><img src="/images/state3.png" alt=""><br>• builtin_machine – 一些内置的状态机可供使用，它们都是两个状态<br>–  any       – Any character in the alphabet.<br>–  ascii   – Ascii characters. 0..127<br>–  extend – This is the range -128..127 for signed alphabets and the range 0..255 for unsigned alphabets.<br>–  alpha   – Alphabetic characters. [A-Za-z]<br>–  digit   – Digits. [0-9]<br>–  alnum   – Alpha numerics. [0-9A-Za-z]<br>–  lower   – Lowercase characters. [a-z]<br>–  upper   – Uppercase characters. [A-Z]<br>–  xdigit – Hexadecimal digits. [0-9A-Fa-f]<br>–  cntrl   – Control characters. 0..31<br>–  graph   – Graphical characters. [!-~]<br>–  print   – Printable characters. [  -~]<br>–  punct  – Punctuation. Graphical characters that are not alphanumerics. [!-/:-@[-‘{-~]<br>–  space   – Whitespace. [\t\v\f\n\r  ]<br>–  zlen     – Zero length string. “”<br>–  empty   – Empty set. Matches nothing. ^any</p>
<h2 id="u64CD_u4F5C_u7B26_u4F18_u5148_u7EA7"><a href="#u64CD_u4F5C_u7B26_u4F18_u5148_u7EA7" class="headerlink" title="操作符优先级"></a>操作符优先级</h2><p>下表给出了从低到高的优先级<br><img src="/images/state4.png" alt=""></p>
<h2 id="u5E38_u89C4_u64CD_u4F5C_u7B26"><a href="#u5E38_u89C4_u64CD_u4F5C_u7B26" class="headerlink" title="常规操作符"></a>常规操作符</h2><p>当使用ragel时，有必要了解它是怎样生成状态机的。<br>可以使用Graphviz调试状态机，ragel.exe -V可以生成ragel脚本的Graphviz Dot文件，然后用Graphviz绘制状态转移图</p>
<h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><pre><code>expr  |  expr
</code></pre><p>生成一个新的状态机，它可以匹配状态机1和状态机2<br><img src="/images/state5.png" alt=""><br>下面是一个例子：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#  Hex  digits,  decimal  digits,  or  identifiers</span></span><br><span class="line">main  :=  ’<span class="number">0</span>x’  xdigit+  |  digit+  |  alpha  alnum*;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/state6.png" alt=""></p>
<h3 id="Intersection__u4EA4_u96C6"><a href="#Intersection__u4EA4_u96C6" class="headerlink" title="Intersection 交集"></a>Intersection 交集</h3><pre><code>expr  &amp;  expr
</code></pre><p>例子：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#  Match  lines  four  characters  wide  that  contain</span></span><br><span class="line"><span class="preprocessor">#  words  separated  by  whitespace.</span></span><br><span class="line">main  :=</span><br><span class="line">/[^\n][^\n][^\n][^\n]\n<span class="comment">/*  &amp;</span><br><span class="line">(/[a-z][a-z]*/</span>  |  [  \n])**;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/state7.png" alt=""></p>
<h3 id="Difference__u5DEE_u96C6"><a href="#Difference__u5DEE_u96C6" class="headerlink" title="Difference 差集"></a>Difference 差集</h3><pre><code>expr  -  expr
</code></pre><p>生成一个新的状态机，它匹配在machine1中不在machine2中的串<br>案例：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#  Subtract  keywords  from  identifiers.</span></span><br><span class="line">main  :=  /[a-z][a-z]*/  -  (  ’<span class="keyword">for</span>’  |  ’<span class="keyword">int</span>’  );</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/state8.png" alt=""></p>
<h2 id="Strong_Difference"><a href="#Strong_Difference" class="headerlink" title="Strong Difference"></a>Strong Difference</h2><pre><code>expr  --  expr
</code></pre><p>生成新状态机，匹配在machine1中，且不包含machine2字串。<br>它等价于expr  -  (  any<em>  expr  any</em>  )<br>例子：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crlf  =  ’\r\n’;</span><br><span class="line">main  :=  [a-z]+  ’:’  (  any*  --  crlf  )  crlf;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/state9.png" alt=""></p>
<h3 id="Concatenation__u4E32_u8054"><a href="#Concatenation__u4E32_u8054" class="headerlink" title="Concatenation 串联"></a>Concatenation 串联</h3><pre><code>expr  .  expr
</code></pre><p>生成新的状态机，它匹配所有machine1 followed machine2的字串。<br><img src="/images/state10.png" alt=""><br>例子：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#最后一行为'EOF\n'</span><br><span class="line">main  :=  /[^\n]*\n/*  .  ’EOF\n’;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/state11.png" alt=""></p>
<h3 id="Kleene_Star__u91CD_u590D_5B0_2C_7E_29_u6B21"><a href="#Kleene_Star__u91CD_u590D_5B0_2C_7E_29_u6B21" class="headerlink" title="Kleene Star 重复[0,~)次"></a>Kleene Star 重复[0,~)次</h3><pre><code>expr*
</code></pre><p><img src="/images/state12.png" alt=""></p>
<h3 id="u91CD_u590D_5B1_2C_7E_29_u6B21"><a href="#u91CD_u590D_5B1_2C_7E_29_u6B21" class="headerlink" title="重复[1,~)次"></a>重复[1,~)次</h3><pre><code>expr+
</code></pre><p>等价于expr  .  expr*<br><img src="/images/state13.png" alt=""></p>
<h3 id="u91CD_u590D_5B0_2C1_5D_u6B21"><a href="#u91CD_u590D_5B0_2C1_5D_u6B21" class="headerlink" title="重复[0,1]次"></a>重复[0,1]次</h3><pre><code>expr?
</code></pre><p>等价于(expr  |  ’’  )<br><img src="/images/state14.png" alt=""></p>
<h3 id="u91CD_u590D_5Bn_2Cm_5D_u6B21"><a href="#u91CD_u590D_5Bn_2Cm_5D_u6B21" class="headerlink" title="重复[n,m]次"></a>重复[n,m]次</h3><pre><code>expr  {n}      – Exactly N copies of expr.
expr  {,n}    – Zero to N copies of expr.
expr  {n,}    – N or more copies of expr.
expr  {n,m}  – N to M copies of expr.
</code></pre><h3 id="u5B57_u7B26_u4E32_u53D6_u53CD"><a href="#u5B57_u7B26_u4E32_u53D6_u53CD" class="headerlink" title="字符串取反"></a>字符串取反</h3><pre><code>!expr
</code></pre><p>等价于(any*  -  expr)</p>
<h3 id="u5B57_u7B26_u53D6_u53CD"><a href="#u5B57_u7B26_u53D6_u53CD" class="headerlink" title="字符取反"></a>字符取反</h3><pre><code>^expr
</code></pre><p>等价于(any  -  expr)</p>
<h2 id="u72B6_u6001_u673A_u7B80_u5316"><a href="#u72B6_u6001_u673A_u7B80_u5316" class="headerlink" title="状态机简化"></a>状态机简化</h2><p>将状态机进行等价转换，减少冗余状态，类似Hopcroft’s状态精简算法</p>
<h1 id="Embedding_Actions_uFF08_u72B6_u6001_u8F6C_u79FB_u52A8_u4F5C_u63D2_u5165_uFF09"><a href="#Embedding_Actions_uFF08_u72B6_u6001_u8F6C_u79FB_u52A8_u4F5C_u63D2_u5165_uFF09" class="headerlink" title="Embedding Actions（状态转移动作插入）"></a>Embedding Actions（状态转移动作插入）</h1><p>ragel允许用户在状态机转移时，嵌入动作代码<br>定义一个动作:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">action  ActionName  &#123;</span><br><span class="line"><span class="comment">/*  Code  an  action  here.  */</span></span><br><span class="line">count  +=  <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>动作名可以在表达式中引用插入。也可以直接{}插入</p>
<p>• &gt;   从start state转移到其他state时<br>• @   从其他state转移到final state时<br>• $   所有状态转移时<br>• %   从final state离开状态机、或eof时</p>
<h2 id="Entering_Action"><a href="#Entering_Action" class="headerlink" title="Entering Action"></a>Entering Action</h2><pre><code>expr  &gt;  action
</code></pre><p>从开始状态进入状态机时，插入动作，如果开始状态也是结束状态，则进入开始状态时，也会插入<br><img src="/images/state15.png" alt=""></p>
<h2 id="Finishing_Action"><a href="#Finishing_Action" class="headerlink" title="Finishing Action"></a>Finishing Action</h2><pre><code>expr  @  action
</code></pre><p>进入final state时，嵌入动作，后续输入可能使状态机退出再进入final state，所以final state可能执行多次<br><img src="/images/state16.png" alt=""></p>
<h2 id="All_Transition_Action"><a href="#All_Transition_Action" class="headerlink" title="All Transition Action"></a>All Transition Action</h2><pre><code>expr  $  action
</code></pre><p>只要状态转移，就嵌入动作<br>案例：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#  Execute  A  on  any  characters  of  the  machine.</span></span><br><span class="line">main  :=  (  ’m1’  |  ’m2’  )  $A;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/state17.png" alt=""></p>
<h2 id="Leaving_Actions"><a href="#Leaving_Actions" class="headerlink" title="Leaving Actions"></a>Leaving Actions</h2><pre><code>expr  %  action
</code></pre><p>从final state离开状态机时，嵌入动作<br><img src="/images/state18.png" alt=""></p>
<h1 id="State_Action_Embedding_Operators"><a href="#State_Action_Embedding_Operators" class="headerlink" title="State Action Embedding Operators"></a>State Action Embedding Operators</h1><p>通过状态嵌入操作符，可以向某个状态嵌入动作。与状态转移嵌入类似，特也有多种类型</p>
<p>The diﬀerent classes of states are:<br>• &gt;   – the start state<br>• &lt;   – any state except the start state<br>• $   – all states<br>• %   – ﬁnal states<br>• @   – any state except ﬁnal states<br>• &lt;&gt; – any except start and ﬁnal (middle)</p>
<p>The diﬀerent kinds of embeddings are:<br>• ~ – to-state actions (to)<br>• * – from-state actions (from)<br>• / – EOF actions (eof)<br>• ! – error actions (err)<br>• ^ – local error actions (lerr)</p>
<h2 id="To-State_and_From-State_Actions"><a href="#To-State_and_From-State_Actions" class="headerlink" title="To-State and From-State Actions"></a>To-State and From-State Actions</h2><p>To-State Actions<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;~action    &gt;to(name)   &gt;to&#123;...&#125;   – the start state</span><br><span class="line">&lt;~action    &lt;to(name)   &lt;to&#123;...&#125;   – any state except the start state</span><br><span class="line">$~action    $to(name)   $to&#123;...&#125;   – all states</span><br><span class="line">%~action    %to(name)   %to&#123;...&#125;   – ﬁnal states</span><br><span class="line">@~action    @to(name)   @to&#123;...&#125;   – any state except ﬁnal states</span><br><span class="line">&lt;&gt;~action   &lt;&gt;to(name)  &lt;&gt;to&#123;...&#125; – any except start and ﬁnal (middle)</span><br></pre></td></tr></table></figure></p>
<p>当状态机move到目标状态时，to-state动作<br>From-State Actions<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;*action         &gt;from(name)         &gt;from&#123;...&#125;   – the start state</span><br><span class="line">&lt;*action         &lt;from(name)         &lt;from&#123;...&#125;   – any state except the start state</span><br><span class="line">$*action         $from(name)         $from&#123;...&#125;   – all states</span><br><span class="line">%*action         %from(name)         %from&#123;...&#125;   – ﬁnal states</span><br><span class="line">@*action         @from(name)         @from&#123;...&#125;   – any state except ﬁnal states</span><br><span class="line">&lt;&gt;*action       &lt;&gt;from(name)       &lt;&gt;from&#123;...&#125; – any except start and ﬁnal (middle)</span><br></pre></td></tr></table></figure></p>
<p>EOF Actions<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;/action         &gt;eof(name)         &gt;eof&#123;...&#125;   – the start state</span><br><span class="line">&lt;/action         &lt;eof(name)         &lt;eof&#123;...&#125;   – any state except the start state</span><br><span class="line">$/action         $eof(name)         $eof&#123;...&#125;   – all states</span><br><span class="line">%/action         %eof(name)         %eof&#123;...&#125;   – ﬁnal states</span><br><span class="line">@/action         @eof(name)         @eof&#123;...&#125;   – any state except ﬁnal states</span><br><span class="line">&lt;&gt;/action       &lt;&gt;eof(name)       &lt;&gt;eof&#123;...&#125; – any except start and ﬁnal (middle)</span><br></pre></td></tr></table></figure></p>
<p>错误处理<br>通过插入错误动作，捕获错误信息<br>Global Error Actions<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;!action         &gt;err(name)         &gt;err&#123;...&#125;   – the start state</span><br><span class="line">&lt;!action         &lt;err(name)         &lt;err&#123;...&#125;   – any state except the start state</span><br><span class="line">$!action         $err(name)         $err&#123;...&#125;   – all states</span><br><span class="line">%!action         %err(name)         %err&#123;...&#125;   – ﬁnal states</span><br><span class="line">@!action         @err(name)         @err&#123;...&#125;   – any state except ﬁnal states</span><br><span class="line">&lt;&gt;!action       &lt;&gt;err(name)       &lt;&gt;err&#123;...&#125; – any except start and ﬁnal (middle)</span><br></pre></td></tr></table></figure></p>
<p>Local Error Actions<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;^action         &gt;lerr(name)         &gt;lerr&#123;...&#125;   – the start state</span><br><span class="line">&lt;^action         &lt;lerr(name)         &lt;lerr&#123;...&#125;   – any state except the start state</span><br><span class="line">$^action         $lerr(name)         $lerr&#123;...&#125;   – all states</span><br><span class="line">%^action         %lerr(name)         %lerr&#123;...&#125;   – ﬁnal states</span><br><span class="line">@^action         @lerr(name)         @lerr&#123;...&#125;   – any state except ﬁnal states</span><br><span class="line">&lt;&gt;^action       &lt;&gt;lerr(name)       &lt;&gt;lerr&#123;...&#125; – any except start and ﬁnal (middle)</span><br></pre></td></tr></table></figure></p>
<p>一个例子：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">action  cmd_err  &#123;</span><br><span class="line">    printf(  "command  error\n"  );</span><br><span class="line">    fhold;  fgoto  line;</span><br><span class="line">&#125;</span><br><span class="line">action  from_err  &#123;</span><br><span class="line">    printf(  "from  error\n"  );</span><br><span class="line">    fhold;  fgoto  line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">action  to_err  &#123;</span><br><span class="line">    printf(  "to  error\n"  );</span><br><span class="line">    fhold;  fgoto  line;</span><br><span class="line">&#125;</span><br><span class="line">line  :=  [^\n]*  '\n'  @&#123;  fgoto  main;  &#125;;</span><br><span class="line">main  :=  (</span><br><span class="line">    (</span><br><span class="line">    'from'  @err(cmd_err)</span><br><span class="line">    (  ws+  address  ws+  date  '\n'  )  $err(from_err)  |</span><br><span class="line">    'to'  @err(cmd_err)</span><br><span class="line">    (  ws+  address  '\n'  )  $err(to_err)</span><br><span class="line">    )</span><br><span class="line">)*;</span><br></pre></td></tr></table></figure></p>
<h2 id="u5728_u52A8_u4F5C_u4EE3_u7801_u4E2D_u53EF_u7528_u7684_u53D8_u91CF_u4E0E_u8868_u8FBE_u5F0F"><a href="#u5728_u52A8_u4F5C_u4EE3_u7801_u4E2D_u53EF_u7528_u7684_u53D8_u91CF_u4E0E_u8868_u8FBE_u5F0F" class="headerlink" title="在动作代码中可用的变量与表达式"></a>在动作代码中可用的变量与表达式</h2><p>如下变量可用:<br>• fpc – 当前缓冲区指针，等价p.<br>• fc – 当前字符值，等价 (*p).<br>• fcurs – 当前状态值，要改变状态，请用fgoto，fnext、fcall，外部可以通过cs变量修改状态<br>• ftargs – 目标状态值.<br>• fentry(<label>) – 返回代表label入口的整数值</label></p>
<p>如下表达式可用：<br>• fhold; – 不再解析当前字符，不会发生状态转移，等价于p–<br>• fexec  <expr>; 设置要处理的下一个字符，等价于修改p值<br>• fgoto  <label>; 跳转到<label>，跳转到目的状态<br>• fgoto  <em><expr>; 跳转到目的状态<br>• fnext  <label>; 设置下一个状态为label入口，它不是马上跳转到目的状态，表达式后面跟的动作代码会执行<br>• fnext  </label></expr></em><expr>; 同上<br>• fcall  <label>; 保存下一个状态，并跳转到目的状态，当执行fret时，从栈中返回到保存状态，使用fcall时，需要提前设置调用栈，两个变量<strong>stack</strong>、<strong>top</strong>.<br>• fcall  *<expr>; 同上<br>• fret;<br>• fbreak; advance p，保存目标状态到cs，跳出execution loop</expr></label></expr></label></label></expr></p>
<h1 id="u5904_u7406_u4E0D_u786E_u5B9A_u6027"><a href="#u5904_u7406_u4E0D_u786E_u5B9A_u6027" class="headerlink" title="处理不确定性"></a>处理不确定性</h1><h1 id="host_u7A0B_u5E8F_u96C6_u6210"><a href="#host_u7A0B_u5E8F_u96C6_u6210" class="headerlink" title="host程序集成"></a>host程序集成</h1><h2 id="Variables_Used_by_Ragel"><a href="#Variables_Used_by_Ragel" class="headerlink" title="Variables Used by Ragel"></a>Variables Used by Ragel</h2><p>ragel需要host语言定义一组变量，至少包括cs、p、pe变量，如果有EOF动作，还需要定义eof变量，如果使用fcall、fret，还需要定义stack、top变量，如果使用了scanner，还需要定义act、ts、te变量</p>
<p>• cs - 当前状态，int类型.  在调用状态机时，必须存在，可以子loop外部修改，不能在loop内部修改<br>• p - 输入缓冲区开始，调用状态机前初始化<br>• pe - 输入缓冲区结束，[p, p+length]为缓冲区<br>• eof - 输入流结束，当输入结束时，可以设置p  =  pe  =  eof，然后调用状态机<br>• data - Go,  Java and Ruby中才用到.<br>• stack - 整数数组指针<br>• top - 整数，栈顶.<br>• act - 整数.<br>• ts - 指针.<br>• te - 指针.<br>一个不包含任何动作的例子：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span>  <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span>  <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line">%%&#123;</span><br><span class="line">    machine  foo;</span><br><span class="line">    write  data;</span><br><span class="line">&#125;%%</span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">main</span><span class="params">(  <span class="keyword">int</span>  argc,  <span class="keyword">char</span>  **argv  )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>  cs;</span><br><span class="line">    <span class="keyword">if</span>  (  argc  &gt;  <span class="number">1</span>  )  &#123;</span><br><span class="line">        <span class="keyword">char</span>  *p  =  argv[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">char</span>  *pe  =  p  +  <span class="built_in">strlen</span>(  p  );</span><br><span class="line">        %%&#123;</span><br><span class="line">            main  :=  [<span class="number">0</span>-<span class="number">9</span>]+  (  <span class="string">'.'</span>  [<span class="number">0</span>-<span class="number">9</span>]+  )?;</span><br><span class="line">            write  init;</span><br><span class="line">            write  exec;</span><br><span class="line">        &#125;%%</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"result  =  %i\n"</span>,  cs  &gt;=  foo_first_final  );</span><br><span class="line">    <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="u6570_u636E_u7C7B_u578B_u5B9A_u4E49"><a href="#u6570_u636E_u7C7B_u578B_u5B9A_u4E49" class="headerlink" title="数据类型定义"></a>数据类型定义</h2><pre><code>alphtype  unsigned  int;
</code></pre><p>默认定义<br>C/C++/Objective-C:<br>char unsigned   char<br>short           unsigned  short<br>int unsigned    int<br>long unsigned   long</p>
<h2 id="Getkey_Statement"><a href="#Getkey_Statement" class="headerlink" title="Getkey Statement"></a>Getkey Statement</h2><pre><code>getkey  fpc-&gt;id;
</code></pre><p>定义如何从p指针获取字符，默认表达式 (*p)</p>
<h2 id="Access_Statement"><a href="#Access_Statement" class="headerlink" title="Access Statement"></a>Access Statement</h2><pre><code>access  fsm-&gt;;
</code></pre><p>定义如何访问状态机内部的数据cs、top、stack、ts、te、act变量，如果所有上下文放在一个结构体中，这里就可以给出结构体变量名称</p>
<h2 id="Variable_Statement"><a href="#Variable_Statement" class="headerlink" title="Variable Statement"></a>Variable Statement</h2><pre><code>variable  p  fsm-&gt;p;
</code></pre><p>如何访问特定变量</p>
<h2 id="Pre-Push_Statement"><a href="#Pre-Push_Statement" class="headerlink" title="Pre-Push Statement"></a>Pre-Push Statement</h2><pre><code>prepush  {
/*  stack  growing  code  */
}
</code></pre><p>动态调整堆栈代码<br>5.7    Post-Pop Statement<br>    postpop  {<br>    /<em>  stack  shrinking  code  </em>/<br>    }<br>动态调整堆栈代码</p>
<h2 id="Write_Statement"><a href="#Write_Statement" class="headerlink" title="Write Statement"></a>Write Statement</h2><pre><code>write  data  [options];
</code></pre><p>生成状态机所需的常量静态数据，其中两个变量比较有用，name_error定义了最后的出错状态（不被接受状态），当解析正确时，name_error为-1，变量name_first_final保存了 ﬁrst ﬁnal状态ID<br>    write  start;<br>    write  first_final;<br>    write  error;<br>另外一种引用start、first_final、error这三个变量的方式，看下面的例子：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  Did  parsing  succeed?  */</span></span><br><span class="line"><span class="keyword">if</span>  (  cs  &lt;  %%&#123;  write  first_final;  &#125;%%  )  &#123;</span><br><span class="line">result  =  ERR_PARSE_ERROR;</span><br><span class="line"><span class="keyword">goto</span>  fail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<pre><code>write  init  [options];
</code></pre><p>生成状态机初始化代码，在调用状态机之前，只能初始化一次，最小情况下，它设置当前状态为start state<br>若加nocs选项，则跳过cs初始化，我们自己需要手动初始化cs</p>
<pre><code>write  exec  [options];
</code></pre><p>生成状态机执行代码，我们需要先准备好一组变量，至少包括p、pe、cs、stack、top等<br>下面一个例子：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>  have  =  <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>  (  <span class="number">1</span>  )  &#123;</span><br><span class="line">    <span class="keyword">char</span>  *p,  *pe,  *data  =  buf  +  have;</span><br><span class="line">    <span class="keyword">int</span>  len,  space  =  BUFSIZE  -  have;</span><br><span class="line">    <span class="keyword">if</span>  (  space  ==  <span class="number">0</span>  )  &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,  <span class="string">"BUFFER  OUT  OF  SPACE\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    len  =  fread(  data,  <span class="number">1</span>,  space,  <span class="built_in">stdin</span>  );</span><br><span class="line">    <span class="keyword">if</span>  (  len  ==  <span class="number">0</span>  )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">/*  Find  the  last  newline  by  searching  backwards.  */</span></span><br><span class="line">    p  =  buf;</span><br><span class="line">    pe  =  data  +  len  -  <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>  (  *pe  !=  ’\n’  &amp;&amp;  pe  &gt;=  buf  )</span><br><span class="line">        pe--;</span><br><span class="line">    pe  +=  <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//准备要处理的数据</span></span><br><span class="line">    %%  write  exec;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拷贝还没处理的数据</span></span><br><span class="line">    <span class="comment">/*  How  much  is  still  in  the  buffer?  */</span></span><br><span class="line">    have  =  data  +  len  -  pe;</span><br><span class="line">    <span class="keyword">if</span>  (  have  &gt;  <span class="number">0</span>  )</span><br><span class="line">        memmove(  buf,  pe,  have  );</span><br><span class="line">    <span class="keyword">if</span>  (  len  &lt;  space  )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ragel.exe生成代码的几个选项<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-T0         binary search table-driven        C/D/Java/Ruby/C<span class="preprocessor">#/Go</span></span><br><span class="line">-T1         binary search, expanded actions        C/D/Ruby/C<span class="preprocessor">#/Go</span></span><br><span class="line">-F0         ﬂat table-driven C/D/Ruby/C<span class="preprocessor">#/Go</span></span><br><span class="line">-F1         ﬂat table, expanded actions C/D/Ruby/C<span class="preprocessor">#/Go</span></span><br><span class="line">-G0         <span class="keyword">goto</span>-driven C/D/C<span class="preprocessor">#/Go</span></span><br><span class="line">-G1         <span class="keyword">goto</span>, expanded actions C/D/C<span class="preprocessor">#/Go</span></span><br><span class="line">-G2         <span class="keyword">goto</span>, in-place actions C/D/Go</span><br></pre></td></tr></table></figure></p>
<p>一般，使用-G2生成的代码最高效</p>
<h1 id="Beyond_the_Basic_Model"><a href="#Beyond_the_Basic_Model" class="headerlink" title="Beyond the Basic Model"></a>Beyond the Basic Model</h1><h2 id="u6A21_u5757_u5316_u89E3_u6790"><a href="#u6A21_u5757_u5316_u89E3_u6790" class="headerlink" title="模块化解析"></a>模块化解析</h2><p>通过jump、call机制，实现模块化解析<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">action  return  &#123;  fret;  &#125;</span><br><span class="line">action  call_date  &#123;  fcall  date;  &#125;</span><br><span class="line">action  call_name  &#123;  fcall  name;  &#125;</span><br><span class="line"></span><br><span class="line">#  A  parser  for  date  strings.</span><br><span class="line">date  :=[0-9][0-9]  '/'</span><br><span class="line">        [0-9][0-9]  '/'</span><br><span class="line">        [0-9][0-9][0-9][0-9]  '/'  @return;</span><br><span class="line"></span><br><span class="line">#  A  parser  for  name  strings. **贪心匹配</span><br><span class="line">name  :=  (  [a-zA-Z]+  |  ' '  )**  '\n'  @return;</span><br><span class="line"></span><br><span class="line">#  The  main  parser.</span><br><span class="line">headers  =</span><br><span class="line">    (  'from'  |  'to'  )  ':'  @call_name  |</span><br><span class="line">    (  'departed'  |  'arrived'  )  ':'  @call_date;</span><br><span class="line">main  :=  headers*;</span><br></pre></td></tr></table></figure></p>
<p>#url 解析<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">%%&#123;</span><br><span class="line">    machine url_parser;</span><br><span class="line"></span><br><span class="line">    action mark &#123; mark = fpc; &#125;</span><br><span class="line">    action mark_host &#123; host_mark = fpc; &#125;</span><br><span class="line"></span><br><span class="line">    action save_host &#123;</span><br><span class="line">        g_string_truncate(uri-&gt;host, 0);</span><br><span class="line">        g_string_append_len(uri-&gt;host, host_mark, fpc - host_mark);</span><br><span class="line">        g_string_ascii_down(uri-&gt;host);</span><br><span class="line">    &#125;</span><br><span class="line">    action save_authority &#123;</span><br><span class="line">        g_string_truncate(uri-&gt;authority, 0);</span><br><span class="line">        g_string_append_len(uri-&gt;authority, mark, fpc - mark);</span><br><span class="line">        g_string_ascii_down(uri-&gt;authority);</span><br><span class="line">    &#125;</span><br><span class="line">    action save_path &#123;</span><br><span class="line">        g_string_append_len(uri-&gt;path, mark, fpc - mark);</span><br><span class="line">        g_string_append_len(uri-&gt;raw_path, mark, fpc - mark);</span><br><span class="line">    &#125;</span><br><span class="line">    action save_query &#123;</span><br><span class="line">        g_string_append_len(uri-&gt;query, mark, fpc - mark);</span><br><span class="line">        g_string_append_len(uri-&gt;raw_path, mark-1, fpc - mark+1); /* include '?' in append */</span><br><span class="line">    &#125;</span><br><span class="line">    action save_scheme &#123;</span><br><span class="line">        g_string_append_len(uri-&gt;scheme, mark, fpc - mark);</span><br><span class="line">    &#125;</span><br><span class="line">    #16进制编码</span><br><span class="line">    pct_encoded = "%" xdigit xdigit;</span><br><span class="line">    </span><br><span class="line">    #各种分隔符</span><br><span class="line">    gen_delims  = ":" | "/" | "?" | "#" | "[" | "]" | "@";</span><br><span class="line">    sub_delims  = "!" | "$" | "&amp;" | "'" | "(" | ")" | "*" | "+" | "," | ";" | "=";</span><br><span class="line"></span><br><span class="line">    reserved    = gen_delims | sub_delims;</span><br><span class="line">    unreserved  = alpha | digit | "-" | "." | "_" | "~";</span><br><span class="line"></span><br><span class="line">    # many clients don't encode these, e.g. curl, wget, ...</span><br><span class="line">    delims      = "&lt;" | "&gt;" | "#" | "%" | '"';</span><br><span class="line">    unwise      = " " | "&#123;" | "&#125;" | "|" | "\\" | "^" | "[" | "]" | "`";</span><br><span class="line"></span><br><span class="line">    pchar = unreserved | pct_encoded | sub_delims | ":" | "@" | delims | unwise;</span><br><span class="line">    path = ("/" ( "/" | pchar)*) &gt;mark %save_path;</span><br><span class="line"></span><br><span class="line">    scheme = "http" | "https";</span><br><span class="line"></span><br><span class="line">#simple ipv4 address</span><br><span class="line">    dec_octet = digit&#123;1,3&#125;;</span><br><span class="line">    IPv4address = dec_octet "." dec_octet "." dec_octet "." dec_octet;</span><br><span class="line"></span><br><span class="line">    IPvFuture  = "v" xdigit+ "." ( unreserved | sub_delims | ":" )+;</span><br><span class="line"></span><br><span class="line"># simple ipv6 address</span><br><span class="line">    IPv6address = (":" | xdigit)+ IPv4address?;</span><br><span class="line"></span><br><span class="line">    IP_literal = "[" ( IPv6address | IPvFuture  ) "]";</span><br><span class="line"></span><br><span class="line">    reg_name = ( unreserved | pct_encoded | sub_delims )+;</span><br><span class="line"></span><br><span class="line">    userinfo    = ( unreserved | pct_encoded | sub_delims | ":" )*;</span><br><span class="line">    host        = IP_literal | IPv4address | reg_name;</span><br><span class="line">    port        = digit+;</span><br><span class="line">    authority   = ( userinfo "@" )? (host &gt;mark_host %save_host) ( ":" port )?;</span><br><span class="line"></span><br><span class="line">    query = ( pchar | "/" | "?" )* &gt;mark %save_query;</span><br><span class="line">    fragment = ( pchar | "/" | "?" )*;</span><br><span class="line"></span><br><span class="line">    URI_path = (path ( "?" query )?) ( "#" fragment )?;</span><br><span class="line"></span><br><span class="line">    URI = (scheme &gt;mark %save_scheme) "://" (authority &gt;mark %save_authority) URI_path;</span><br><span class="line"></span><br><span class="line">    parse_URI := URI | ("*" &gt;mark %save_path) | URI_path;</span><br><span class="line">    parse_URI_path := URI_path;</span><br><span class="line">    parse_Hostname := (host &gt;mark_host %save_host) ( ":" port )?;</span><br><span class="line"></span><br><span class="line">    write data;</span><br><span class="line">&#125;%%</span><br><span class="line"></span><br><span class="line">gboolean li_parse_raw_url(liRequestUri *uri) &#123;</span><br><span class="line">    const char *p, *pe, *eof;</span><br><span class="line">    const char *mark = NULL, *host_mark = NULL;</span><br><span class="line">    int cs;</span><br><span class="line"></span><br><span class="line">    p = uri-&gt;raw-&gt;str;</span><br><span class="line">    eof = pe = uri-&gt;raw-&gt;str + uri-&gt;raw-&gt;len;</span><br><span class="line"></span><br><span class="line">    %% write init nocs;</span><br><span class="line">    cs = url_parser_en_parse_URI;</span><br><span class="line"></span><br><span class="line">    %% write exec;</span><br><span class="line"></span><br><span class="line">    return (cs &gt;= url_parser_first_final);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gboolean li_parse_raw_path(liRequestUri *uri, GString *input) &#123;</span><br><span class="line">    const char *p, *pe, *eof;</span><br><span class="line">    const char *mark = NULL, *host_mark = NULL;</span><br><span class="line">    int cs;</span><br><span class="line"></span><br><span class="line">    p = input-&gt;str;</span><br><span class="line">    eof = pe = input-&gt;str + input-&gt;len;</span><br><span class="line"></span><br><span class="line">    g_string_truncate(uri-&gt;path, 0);</span><br><span class="line">    g_string_truncate(uri-&gt;raw_path, 0);</span><br><span class="line">    g_string_truncate(uri-&gt;query, 0);</span><br><span class="line"></span><br><span class="line">    %% write init nocs;</span><br><span class="line">    cs = url_parser_en_parse_URI_path;</span><br><span class="line"></span><br><span class="line">    %% write exec;</span><br><span class="line"></span><br><span class="line">    if (cs &gt;= url_parser_first_final) &#123;</span><br><span class="line">        li_url_decode(uri-&gt;path);</span><br><span class="line">        li_path_simplify(uri-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (cs &gt;= url_parser_first_final);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gboolean li_parse_hostname(liRequestUri *uri) &#123;</span><br><span class="line">    const char *p, *pe, *eof;</span><br><span class="line">    const char *mark = NULL, *host_mark = NULL;</span><br><span class="line">    int cs;</span><br><span class="line"></span><br><span class="line">    g_string_ascii_down(uri-&gt;authority);</span><br><span class="line">    p = uri-&gt;authority-&gt;str;</span><br><span class="line">    eof = pe = uri-&gt;authority-&gt;str + uri-&gt;authority-&gt;len;</span><br><span class="line"></span><br><span class="line">    %% write init nocs;</span><br><span class="line">    cs = url_parser_en_parse_Hostname;</span><br><span class="line"></span><br><span class="line">    %% write exec;</span><br><span class="line"></span><br><span class="line">    return (cs &gt;= url_parser_first_final);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="atoi_u6848_u4F8B_u5206_u6790"><a href="#atoi_u6848_u4F8B_u5206_u6790" class="headerlink" title="atoi案例分析"></a>atoi案例分析</h1><p>上代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">%%&#123;</span><br><span class="line"><span class="preprocessor">#状态机名称</span></span><br><span class="line">    machine atoi;   </span><br><span class="line"><span class="preprocessor">#写入状态机用到的常量</span></span><br><span class="line">    write data;</span><br><span class="line">    action see_neg &#123;</span><br><span class="line">        neg = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    action add_digit &#123; </span><br><span class="line">        val = val * <span class="number">10</span> + (fc - <span class="string">'0'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    main := </span><br><span class="line">        ( <span class="string">'-'</span>@see_neg | <span class="string">'+'</span> )? ( digit @add_digit )+ </span><br><span class="line">        <span class="string">'\n'</span>;</span><br><span class="line">&#125;%%</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">atoi</span><span class="params">( <span class="keyword">char</span> *str )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p = str, *pe = str + <span class="built_in">strlen</span>( str );</span><br><span class="line">    <span class="keyword">int</span> cs;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> neg = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    %%&#123;</span><br><span class="line">        <span class="preprocessor">#初始化状态机</span></span><br><span class="line">        write init;</span><br><span class="line">        <span class="preprocessor">#生成代码</span></span><br><span class="line">        write exec;</span><br><span class="line">    &#125;%%</span><br><span class="line">    <span class="keyword">if</span> ( neg )</span><br><span class="line">        val = -<span class="number">1</span> * val;</span><br><span class="line">    <span class="keyword">if</span> ( cs &lt; atoi_first_final )这里也可以改为%%&#123;write  first_final;&#125;%%</span><br><span class="line">        <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"atoi: there was an error\n"</span> );</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> ( fgets( buf, <span class="keyword">sizeof</span>(buf), <span class="built_in">stdin</span> ) != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> value = atoi( buf );</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">"%lld\n"</span>, value );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="awk_u6848_u4F8B_u5206_u6790"><a href="#awk_u6848_u4F8B_u5206_u6790" class="headerlink" title="awk案例分析"></a>awk案例分析</h1><p>上代码<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">%%&#123;</span><br><span class="line">    machine awkemu;</span><br><span class="line">    action start_word &#123;</span><br><span class="line">        ws[nwords] = fpc;   保存word起始地址</span><br><span class="line">    &#125;</span><br><span class="line">    action end_word &#123;</span><br><span class="line">        we[nwords++] = fpc; 保存word结束地址</span><br><span class="line">    &#125;</span><br><span class="line">    action start_line &#123;</span><br><span class="line">        nwords = <span class="number">0</span>;</span><br><span class="line">        ls = fpc;</span><br><span class="line">    &#125;</span><br><span class="line">    action end_line &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"endline(%i): "</span>, nwords );</span><br><span class="line">        fwrite( ls, <span class="number">1</span>, p - ls, <span class="built_in">stdout</span> );</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; nwords; i++ ) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"  word: "</span>);</span><br><span class="line">            fwrite( ws[i], <span class="number">1</span>, we[i] - ws[i], <span class="built_in">stdout</span> );</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="preprocessor">#^相当于any - expr只对单个字符有效</span></span><br><span class="line">    word = ^[ \t\n]+; </span><br><span class="line">    <span class="preprocessor">#空格</span></span><br><span class="line">    whitespace = [ \t];</span><br><span class="line">    <span class="preprocessor">#进入word状态机时，调用start_word，离开word状态机时，调用end_word</span></span><br><span class="line">    blineElements = word &gt;start_word %end_word | whitespace;</span><br><span class="line">    <span class="preprocessor">#进入一行时，调用start_line，到final state时，调用end_line</span></span><br><span class="line">    line = ( blineElements** <span class="string">'\n'</span> ) &gt;start_line @end_line;</span><br><span class="line"></span><br><span class="line">    main := line*;</span><br><span class="line">&#125;%%</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#不要生成final、<span class="keyword">error</span>变量</span></span><br><span class="line">%% write data noerror nofinal;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, nwords = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *ls = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *ws[<span class="number">4096</span>];</span><br><span class="line">    <span class="keyword">char</span> *we[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">int</span> cs;</span><br><span class="line">    <span class="keyword">int</span> have = <span class="number">0</span>;</span><br><span class="line">    初始化状态机</span><br><span class="line">    %% write init;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="keyword">char</span> *p, *pe, *data = buf + have;</span><br><span class="line">        <span class="keyword">int</span> len, space = BUFSIZE - have;</span><br><span class="line">        <span class="keyword">if</span> ( space == <span class="number">0</span> ) &#123; </span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"buffer out of space\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = fread( data, <span class="number">1</span>, space, <span class="built_in">stdin</span> );</span><br><span class="line">        <span class="keyword">if</span> ( len == <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        p = buf;</span><br><span class="line">        pe = buf + have + len - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ( *pe != <span class="string">'\n'</span> &amp;&amp; pe &gt;= buf )</span><br><span class="line">            pe--;</span><br><span class="line">        pe += <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        动作代码</span><br><span class="line">        %% write exec;</span><br><span class="line">        have = data + len - pe;</span><br><span class="line">        <span class="keyword">if</span> ( have &gt; <span class="number">0</span> )</span><br><span class="line">            memmove( buf, pe, have );</span><br><span class="line">        <span class="keyword">if</span> ( len &lt; space )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( have &gt; <span class="number">0</span> )</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"input not newline terminated\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="C_u6587_u6CD5_u6848_u4F8B_u5206_u6790"><a href="#C_u6587_u6CD5_u6848_u4F8B_u5206_u6790" class="headerlink" title="C文法案例分析"></a>C文法案例分析</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">%%&#123;</span><br><span class="line">    machine clang;</span><br><span class="line">    #统计行数</span><br><span class="line">    newline = '\n' @&#123;curline += 1;&#125;;</span><br><span class="line">    any_count_line = any | newline;</span><br><span class="line"></span><br><span class="line">    #以*/结束</span><br><span class="line">    c_comment := any_count_line* :&gt;&gt; '*/' @&#123;fgoto main;&#125;;</span><br><span class="line">    </span><br><span class="line">    #|*表示scanner状态机开始</span><br><span class="line">    #scanner状态机与lex相似，多条规则中，按最长匹配</span><br><span class="line">    main := |*</span><br><span class="line">        alnum_u = [0-9A-Za-z] | '_'; </span><br><span class="line">        alpha_u = [A-Za-z] | '_';</span><br><span class="line">        </span><br><span class="line">        #punct为可显示字符中-[A-Za-z]部分，包括[!-/:-@[-'&#123;-~]</span><br><span class="line">        ( punct - [_'"] ) &#123;</span><br><span class="line">            printf( "symbol(%i): %c\n", curline, ts[0] );</span><br><span class="line">        &#125;;</span><br><span class="line">        #标识符</span><br><span class="line">        alpha_u alnum_u* &#123;</span><br><span class="line">            printf( "ident(%i): ", curline );</span><br><span class="line">            fwrite( ts, 1, te-ts, stdout );</span><br><span class="line">            printf("\n");</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        sliteralChar = [^'\\] | newline | ( '\\' . any_count_line );</span><br><span class="line">        '\'' . sliteralChar* . '\'' &#123;</span><br><span class="line">            printf( "single_lit(%i): ", curline );</span><br><span class="line">            fwrite( ts, 1, te-ts, stdout );</span><br><span class="line">            printf("\n");</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        dliteralChar = [^"\\] | newline | ( '\\' any_count_line );</span><br><span class="line">        '"' . dliteralChar* . '"' &#123;</span><br><span class="line">            printf( "double_lit(%i): ", curline );</span><br><span class="line">            fwrite( ts, 1, te-ts, stdout );</span><br><span class="line">            printf("\n");</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        any_count_line - 0x21..0x7e;</span><br><span class="line">        '//' [^\n]* newline;</span><br><span class="line"></span><br><span class="line">        '/*' &#123; fgoto c_comment; &#125;;</span><br><span class="line"></span><br><span class="line">        digit+ &#123;</span><br><span class="line">            printf( "int(%i): ", curline );</span><br><span class="line">            fwrite( ts, 1, te-ts, stdout );</span><br><span class="line">            printf("\n");</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        digit+ '.' digit+ &#123;</span><br><span class="line">            printf( "float(%i): ", curline );</span><br><span class="line">            fwrite( ts, 1, te-ts, stdout );</span><br><span class="line">            printf("\n");</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        '0x' xdigit+ &#123;</span><br><span class="line">            printf( "hex(%i): ", curline );</span><br><span class="line">            fwrite( ts, 1, te-ts, stdout );</span><br><span class="line">            printf("\n");</span><br><span class="line">        &#125;;</span><br><span class="line">        #*|表示状态机结束</span><br><span class="line">    *|;</span><br><span class="line"></span><br><span class="line">    write data nofinal;</span><br><span class="line">&#125;%%</span><br><span class="line">void scanner()&#123;</span><br><span class="line">    static char buf[BUFSIZE];</span><br><span class="line">    int cs, act, have = 0, curline = 1;</span><br><span class="line">    char *ts, *te = 0;</span><br><span class="line">    int done = 0;</span><br><span class="line">    %% write init;</span><br><span class="line">    while ( !done ) &#123;</span><br><span class="line">        char *p = buf + have, *pe, *eof = 0;</span><br><span class="line">        int len, space = BUFSIZE - have;</span><br><span class="line">        len = fread( p, 1, space, stdin );</span><br><span class="line">        pe = p + len;</span><br><span class="line"></span><br><span class="line">        %% write exec;</span><br><span class="line">        if ( cs == clang_error ) &#123;</span><br><span class="line">            fprintf(stderr, "PARSE ERROR\n" );</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( ts == 0 )</span><br><span class="line">            have = 0;</span><br><span class="line">        else &#123;</span><br><span class="line">            have = pe - ts;</span><br><span class="line">            memmove( buf, ts, have );</span><br><span class="line">            te = buf + (te-ts);</span><br><span class="line">            ts = buf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="u591A_u72B6_u6001_u673A_u5B9E_u4F8B"><a href="#u591A_u72B6_u6001_u673A_u5B9E_u4F8B" class="headerlink" title="多状态机实例"></a>多状态机实例</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">#define BUFSIZE 2048</span><br><span class="line">struct Concurrent   #状态机上下文</span><br><span class="line">&#123;</span><br><span class="line">    int cur_char;</span><br><span class="line">    int start_word;</span><br><span class="line">    int start_comment;</span><br><span class="line">    int start_literal;</span><br><span class="line">    int cs;</span><br><span class="line">    int init( );</span><br><span class="line">    int execute( const char *data, int len, bool isEof );</span><br><span class="line">    int finish( );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">%%&#123;</span><br><span class="line">    machine Concurrent;</span><br><span class="line">    action next_char &#123;</span><br><span class="line">        cur_char += 1;</span><br><span class="line">    &#125;</span><br><span class="line">    action start_word &#123;</span><br><span class="line">        start_word = cur_char;</span><br><span class="line">    &#125;</span><br><span class="line">    action end_word &#123;</span><br><span class="line">        cout &lt;&lt; "word: " &lt;&lt; start_word &lt;&lt; " " &lt;&lt; cur_char-1 &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    action start_comment &#123;</span><br><span class="line">        start_comment = cur_char;</span><br><span class="line">    &#125;</span><br><span class="line">    action end_comment &#123;</span><br><span class="line">        cout &lt;&lt; "comment: " &lt;&lt; start_comment &lt;&lt; " " &lt;&lt; cur_char-1 &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    action start_literal &#123;</span><br><span class="line">        start_literal = cur_char;</span><br><span class="line">    &#125;</span><br><span class="line">    action end_literal &#123;</span><br><span class="line">        cout &lt;&lt; "literal: " &lt;&lt; start_literal &lt;&lt; " " &lt;&lt; cur_char-1 &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    # Count characters.</span><br><span class="line">    chars = ( any @next_char )*;</span><br><span class="line"></span><br><span class="line">    # Words are non-whitespace. </span><br><span class="line">    word = ( any-space )+ &gt;start_word %end_word;</span><br><span class="line">    words = ( ( word | space ) $1 %0 )*;</span><br><span class="line"></span><br><span class="line">    comment = ( '/*' any* :&gt;&gt; '*/' ) &gt;start_comment %end_comment;</span><br><span class="line">    comments = ( comment | any )**;</span><br><span class="line"></span><br><span class="line">    literalChar = ( any - ['\\] ) | ( '\\' . any );</span><br><span class="line">    literal = ('\'' literalChar* '\'' ) &gt;start_literal %end_literal;</span><br><span class="line">    literals = ( ( literal | (any-'\'') ) $1 %0 )*;</span><br><span class="line"></span><br><span class="line">    main := chars | words | comments | literals;</span><br><span class="line">&#125;%%</span><br><span class="line"></span><br><span class="line">%% write data;</span><br><span class="line"></span><br><span class="line">int Concurrent::init( )</span><br><span class="line">&#123;</span><br><span class="line">    %% write init;</span><br><span class="line">    cur_char = 0;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int Concurrent::execute( const char *data, int len, bool isEof )</span><br><span class="line">&#123;</span><br><span class="line">    const char *p = data;</span><br><span class="line">    const char *pe = data + len;</span><br><span class="line">    const char *eof = isEof ? pe : 0;</span><br><span class="line"></span><br><span class="line">    %% write exec;</span><br><span class="line"></span><br><span class="line">    if ( cs == Concurrent_error )</span><br><span class="line">        return -1;</span><br><span class="line">    if ( cs &gt;= Concurrent_first_final )</span><br><span class="line">        return 1;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int Concurrent::finish( )</span><br><span class="line">&#123;</span><br><span class="line">    if ( cs == Concurrent_error )</span><br><span class="line">        return -1;</span><br><span class="line">    if ( cs &gt;= Concurrent_first_final )</span><br><span class="line">        return 1;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Concurrent concurrent;</span><br><span class="line">char buf[BUFSIZE];</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    concurrent.init();</span><br><span class="line">    while ( 1 ) &#123;</span><br><span class="line">        int len = fread( buf, 1, BUFSIZE, stdin );</span><br><span class="line">        concurrent.execute( buf, len, len != BUFSIZE );</span><br><span class="line">        if ( len != BUFSIZE )</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( concurrent.finish() &lt;= 0 ) cerr &lt;&lt; "concurrent: error parsing input" &lt;&lt; endl;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="gotocallret_u4F7F_u7528"><a href="#gotocallret_u4F7F_u7528" class="headerlink" title="gotocallret使用"></a>gotocallret使用</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> GotoCallRet </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> comm;</span><br><span class="line">    <span class="keyword">int</span> cs, top, <span class="built_in">stack</span>[<span class="number">32</span>];</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">init</span><span class="params">( )</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">execute</span><span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *data, <span class="keyword">int</span> len, <span class="keyword">bool</span> isEof )</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">finish</span><span class="params">( )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">%%&#123;</span><br><span class="line">    machine GotoCallRet;</span><br><span class="line">    garble_line := ( (any-<span class="string">'\n'</span>)* <span class="string">'\n'</span> ) &gt;&#123;<span class="built_in">cout</span> &lt;&lt; <span class="string">"error: garbling line"</span> &lt;&lt; endl;&#125; @&#123;fgoto main;&#125;;</span><br><span class="line"></span><br><span class="line">    alp_comm := alpha+ $!&#123;fhold;fret;&#125;;</span><br><span class="line">    dig_comm := digit+ $!&#123;fhold;fret;&#125;;</span><br><span class="line">    action comm_arg &#123;</span><br><span class="line">        <span class="keyword">if</span> ( comm &gt;= <span class="string">'a'</span> )</span><br><span class="line">            fcall alp_comm;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            fcall dig_comm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    command = (</span><br><span class="line">        [a-z0-<span class="number">9</span>] @&#123;comm = fc;&#125; <span class="string">' '</span> @comm_arg <span class="string">'\n'</span></span><br><span class="line">    ) @&#123;<span class="built_in">cout</span> &lt;&lt; <span class="string">"correct command"</span> &lt;&lt; endl;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="preprocessor"># Any number of commands. If there is an </span></span><br><span class="line">    <span class="preprocessor"># <span class="keyword">error</span> anywhere, garble the <span class="keyword">line</span>.</span></span><br><span class="line">    main := command* $!&#123;fhold;fgoto garble_line;&#125;;</span><br><span class="line">&#125;%%</span><br><span class="line">%% write data;</span><br><span class="line"><span class="keyword">int</span> GotoCallRet::init( )</span><br><span class="line">&#123;</span><br><span class="line">    %% write init;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> GotoCallRet::execute( <span class="keyword">const</span> <span class="keyword">char</span> *data, <span class="keyword">int</span> len, <span class="keyword">bool</span> isEof )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *p = data;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pe = data + len;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *eof = isEof ? pe : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    %% write exec;</span><br><span class="line">    <span class="keyword">if</span> ( cs == GotoCallRet_error )</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( cs &gt;= GotoCallRet_first_final )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> BUFSIZE <span class="number">1024</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFSIZE];</span><br><span class="line"></span><br><span class="line">    GotoCallRet gcr;</span><br><span class="line">    gcr.init();</span><br><span class="line">    <span class="keyword">while</span> ( fgets( buf, <span class="keyword">sizeof</span>(buf), <span class="built_in">stdin</span> ) != <span class="number">0</span> )</span><br><span class="line">        gcr.execute( buf, <span class="built_in">strlen</span>(buf), <span class="literal">false</span> );</span><br><span class="line"></span><br><span class="line">    gcr.execute( <span class="number">0</span>, <span class="number">0</span>, <span class="literal">true</span> );</span><br><span class="line">    <span class="keyword">if</span> ( gcr.cs &lt; GotoCallRet_first_final )</span><br><span class="line">        <span class="built_in">cerr</span> &lt;&lt; <span class="string">"gotocallret: error: parsing input"</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/08/23/2015-08-吴恩达机器学习笔记1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"></strong>
      <div class="article-nav-title">
        
          吴恩达机器学习笔记1
        
      </div>
    </a>
  
  
    <a href="/2015/08/18/2015-08-C-11中一些有用的特性/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">C++11中一些有用的特性</div>
      <strong class="article-nav-caption"></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 uxfork
    	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script type="text/javascript">
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	};
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"-->


  </div>
</body>
</html>